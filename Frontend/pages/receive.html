<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RestaurantIQ ‚Äî Receive Inventory</title>
  <link rel="stylesheet" href="../css/app-light.css">
</head>

<body>

  <nav class="topnav">
    <div class="topnav-brand">
      <div class="topnav-icon">R</div>
      <div>
        <div class="topnav-title">RestaurantIQ</div>
        <div class="topnav-sub">Receive Delivery</div>
      </div>
    </div>
    <div class="topnav-links">
      <button class="topnav-link" onclick="go('dashboard')">Dashboard</button>
      <button class="topnav-link" onclick="go('upload')">Upload</button>
      <button class="topnav-link active" onclick="go('receive')">Receive</button>
      <button class="topnav-link" onclick="go('count')">Count</button>
    </div>
    <div class="topnav-actions">
      <button class="btn btn-outline" onclick="signOut()">‚èª</button>
    </div>
  </nav>

  <div class="page-narrow">
    <h1 style="color:var(--text-primary);font-size:22px;margin-bottom:8px;" class="animate-in">
      Receive Inventory
    </h1>
    <p style="color:var(--text-muted);font-size:13px;margin-bottom:28px;" class="animate-in stagger-1">
      Upload a US Foods invoice to automatically update stock, or manually record a delivery below.
    </p>

    <!-- INVOICE UPLOAD SECTION -->
    <div class="card animate-in stagger-2" style="margin-bottom: 24px; border: 1px dashed var(--border-color);">
      <div class="section-header" style="margin-top:0;">
        <h2>üìÑ Upload Invoice (US Foods)</h2>
      </div>

      <div class="form-group">
        <label class="form-label">Select PDF Invoice</label>
        <input type="file" id="invoice-upload" accept=".pdf" class="form-input">
      </div>

      <button class="btn btn-secondary btn-block" id="analyze-btn" onclick="analyzeInvoice()">
        Analyze Invoice
      </button>

      <!-- Results Container -->
      <div id="invoice-results" style="display:none; margin-top:20px;">
        <h3 style="font-size:14px; margin-bottom:10px; color:var(--text-primary);">Matched Items</h3>
        <div style="overflow-x:auto;">
          <table class="data-table" id="matches-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all" checked onchange="toggleAllMatches(this)"></th>
                <th>Ingredient</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody id="matches-tbody"></tbody>
          </table>
        </div>

        <div id="unmatched-count" style="margin-top:10px; font-size:12px; color:var(--text-muted);"></div>

        <button class="btn btn-primary btn-block" id="confirm-invoice-btn" onclick="confirmInvoiceReceive()"
          style="margin-top:16px;">
          Confirm & Receive Selected
        </button>
      </div>

      <div id="invoice-status" style="margin-top:10px;"></div>
    </div>

    <!-- MANUAL ENTRY SECTION -->
    <div class="card animate-in stagger-2">
      <div class="section-header" style="margin-top:0;">
        <h2>Manual Entry</h2>
      </div>
      <div class="form-group">
        <label class="form-label">Ingredient</label>
        <select class="form-select" id="ingredient-select">
          <option value="">Loading ingredients...</option>
        </select>
        <div style="color:var(--text-dim);font-size:11px;margin-top:4px;" id="current-stock"></div>
      </div>

      <div class="form-group">
        <label class="form-label">Quantity Received</label>
        <input type="number" class="form-input mono" id="qty-input" placeholder="0" min="0.01" step="0.01">
      </div>

      <div class="form-group">
        <label class="form-label">Note (optional)</label>
        <input type="text" class="form-input" id="note-input" placeholder="e.g. Weekly delivery from Sysco">
      </div>

      <button class="btn btn-primary btn-block btn-lg" id="submit-btn" onclick="submitReceive()">
        Receive Inventory
      </button>

      <div id="status-msg"></div>
    </div>

    <!-- Recent receipts -->
    <div class="section-header">
      <h2>Recent Receipts</h2>
    </div>
    <div class="card" style="padding:0;overflow:hidden;">
      <table class="data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Ingredient</th>
            <th>Qty</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="receipts-tbody"></tbody>
      </table>
    </div>

    <div class="page-footer">RestaurantIQ v0.1</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/env.js"></script>
  <script src="../js/supabase-client.js"></script>

  <!-- Import Module Script -->
  <script type="module">
    import { getInvoiceMatches } from '../js/invoice-matcher.js';

    window.analyzeInvoice = async function () {
      const fileInput = document.getElementById('invoice-upload');
      const file = fileInput.files[0];
      const statusEl = document.getElementById('invoice-status');

      if (!file) {
        statusEl.innerHTML = '<span style="color:var(--red)">Please select a PDF file first</span>';
        return;
      }

      try {
        statusEl.innerHTML = '<span style="color:var(--blue)">Analyzing PDF... this may take a moment</span>';
        document.getElementById('analyze-btn').disabled = true;

        const { matches, unmatched } = await getInvoiceMatches(file, sb);

        renderMatches(matches, unmatched);
        statusEl.innerHTML = '';
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = `<span style="color:var(--red)">Error: ${err.message}</span>`;
      } finally {
        document.getElementById('analyze-btn').disabled = false;
      }
    };

    let currentMatches = [];

    function renderMatches(matches, unmatched) {
      currentMatches = matches;
      const container = document.getElementById('invoice-results');
      const tbody = document.getElementById('matches-tbody');
      const unmatchedEl = document.getElementById('unmatched-count');

      container.style.display = 'block';

      if (matches.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No ingredients matched from this invoice.</td></tr>';
        document.getElementById('confirm-invoice-btn').disabled = true;
        return;
      }

      document.getElementById('confirm-invoice-btn').disabled = false;

      tbody.innerHTML = matches.map((m, idx) => `
        <tr>
          <td><input type="checkbox" class="match-checkbox" data-idx="${idx}" checked></td>
          <td style="font-weight:500;">${m.ingredientName}</td>
          <td class="mono" style="color:var(--green)">+${m.qtyShipped}</td>
          <td class="mono" style="font-size:12px;">${m.ingredientUnit}</td>
          <td style="font-size:11px; color:var(--text-muted)">
            Ordered: ${m.qtyOrdered}<br>Product #: ${m.productNumber}
          </td>
        </tr>
      `).join('');

      unmatchedEl.textContent = `${unmatched.length} unmatched line items hidden.`;
    }

    window.toggleAllMatches = function (source) {
      const checkboxes = document.querySelectorAll('.match-checkbox');
      checkboxes.forEach(cb => cb.checked = source.checked);
    };

    window.confirmInvoiceReceive = async function () {
      const checkboxes = document.querySelectorAll('.match-checkbox:checked');
      if (checkboxes.length === 0) return;

      const btn = document.getElementById('confirm-invoice-btn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      let successCount = 0;
      let failCount = 0;

      for (const cb of checkboxes) {
        const idx = parseInt(cb.getAttribute('data-idx'));
        const item = currentMatches[idx];

        try {
          const { error } = await sb.rpc('receive_inventory', {
            p_ingredient_id: item.ingredientId,
            p_qty: item.qtyShipped,
            p_note: `Invoice Upload: ${item.productNumber}`
          });

          if (error) throw error;
          successCount++;
        } catch (e) {
          console.error('Failed to receive item:', item, e);
          failCount++;
        }
      }

      alert(`Processed invoice.\nSuccess: ${successCount}\nFailed: ${failCount}`);

      // Reset
      btn.textContent = 'Confirm & Receive Selected';
      btn.disabled = false;
      document.getElementById('invoice-results').style.display = 'none';
      document.getElementById('invoice-upload').value = '';

      // Refresh recents
      loadRecentReceipts();
    };
  </script>

  <script src="../js/supabase-client.js"></script> <!-- Already included above, but keep order -->
  <script>
    // Existing manual scripts below...
    function go(page) { window.location.href = page + '.html'; }


    let ingredients = [];

    (async () => {
      await requireAuth('../login.html');
      await loadIngredients();
      loadRecentReceipts();
    })();

    async function loadIngredients() {
      const { data, error } = await sb.from('ingredients').select('id, name, unit');
      if (error) { showToast('Failed to load ingredients', 'error'); return; }
      ingredients = data || [];

      const sel = document.getElementById('ingredient-select');
      sel.innerHTML = '<option value="">‚Äî Select ingredient ‚Äî</option>' +
        ingredients.map(i => `<option value="${i.id}">${i.name} (${i.unit})</option>`).join('');

      sel.addEventListener('change', async () => {
        const id = sel.value;
        if (!id) { document.getElementById('current-stock').textContent = ''; return; }
        // Fetch current on-hand
        const { data: oh } = await sb.from('inventory_on_hand').select('qty_on_hand').eq('ingredient_id', id).single();
        const ing = ingredients.find(i => i.id === id);
        document.getElementById('current-stock').textContent =
          oh ? `Current on-hand: ${oh.qty_on_hand} ${ing?.unit || ''}` : 'No inventory record yet';
      });
    }

    async function submitReceive() {
      const id = document.getElementById('ingredient-select').value;
      const qty = parseFloat(document.getElementById('qty-input').value);
      const note = document.getElementById('note-input').value || null;

      if (!id) { setStatus('Select an ingredient', 'error'); return; }
      if (!qty || qty <= 0) { setStatus('Enter a valid quantity', 'error'); return; }

      document.getElementById('submit-btn').disabled = true;
      setStatus('Processing...', 'info');

      const { data, error } = await sb.rpc('receive_inventory', {
        p_ingredient_id: id, p_qty: qty, p_note: note
      });

      if (error || data?.status === 'error') {
        setStatus('‚ùå ' + (data?.message || error?.message), 'error');
        document.getElementById('submit-btn').disabled = false;
        return;
      }

      const ing = ingredients.find(i => i.id === id);
      setStatus(`‚úÖ Received ${qty} ${ing?.unit || ''} of ${ing?.name}. New on-hand: ${data.new_qty_on_hand}`, 'success');
      showToast('Delivery recorded!', 'success');

      document.getElementById('qty-input').value = '';
      document.getElementById('note-input').value = '';
      document.getElementById('current-stock').textContent = `Current on-hand: ${data.new_qty_on_hand} ${ing?.unit || ''}`;
      document.getElementById('submit-btn').disabled = false;
      loadRecentReceipts();
    }

    async function loadRecentReceipts() {
      const { data } = await sb
        .from('inventory_txns')
        .select('created_at, qty_delta, note, ingredients(name, unit)')
        .eq('txn_type', 'RECEIVE')
        .order('created_at', { ascending: false })
        .limit(10);

      document.getElementById('receipts-tbody').innerHTML = (data || []).map(t => `
        <tr>
          <td class="mono" style="font-size:12px;">${new Date(t.created_at).toLocaleDateString()}</td>
          <td style="color:var(--text-primary)">${t.ingredients?.name || '‚Äî'}</td>
          <td class="mono" style="color:var(--accent)">+${t.qty_delta} ${t.ingredients?.unit || ''}</td>
          <td style="color:var(--text-muted);font-size:12px;">${t.note || '‚Äî'}</td>
        </tr>
      `).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:20px;">No receipts yet</td></tr>';
    }

    function setStatus(msg, type) {
      const el = document.getElementById('status-msg');
      el.className = `status-msg ${type}`;
      el.textContent = msg;
    }
  </script>
</body>

</html>